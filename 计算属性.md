# è®¡ç®—å±æ€§

Â Â Â Â è®¡ç®—å±æ€§å…è®¸ç”¨æˆ·å®šä¹‰ä¸€ä¸ªè®¡ç®—æ–¹æ³•ï¼Œç„¶åæ ¹æ®ä¸€äº›ä¾èµ–çš„å“åº”å¼æ•°æ®è®¡ç®—å‡ºæ–°å€¼å¹¶è¿”å›ã€‚å½“ä¾èµ–å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè®¡ç®—å±æ€§ä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—å¹¶è·å–æ–°å€¼ã€‚

åˆ›å»ºä¸€ä¸ªåªè¯»çš„è®¡ç®—å±æ€§ refï¼š

```ts
const count = ref(1)
const plusOne = computed(() => count.value + 1)

console.log(plusOne.value) // 2

plusOne.value++ // é”™è¯¯
```

åˆ›å»ºä¸€ä¸ªå¯å†™çš„è®¡ç®—å±æ€§ refï¼š

```ts
const count = ref(1)
const plusOne = computed({
  get: () => count.value + 1,
  set: (val) => {
    count.value = val - 1
  }
})

plusOne.value = 1
console.log(count.value) // 0
```

æˆ‘ä»¬çœ‹çœ‹computedçš„å®ç°ï¼š

```ts
 function computed<T>(
  getterOrOptions: ComputedGetter<T> | WritableComputedOptions<T>,
  debugOptions?: DebuggerOptions,
  isSSR = false
) {
  // getter å‡½æ•°
  let getter: ComputedGetter<T>
  // setter å‡½æ•°
  let setter: ComputedSetter<T>

  const onlyGetter = isFunction(getterOrOptions)
  // æ ‡å‡†åŒ–å‚æ•°
  if (onlyGetter) {
    // è¡¨é¢ä¼ å…¥çš„æ˜¯ getter å‡½æ•°ï¼Œä¸èƒ½ä¿®æ”¹è®¡ç®—å±æ€§çš„å€¼
    getter = getterOrOptions
    setter = __DEV__
      ? () => {
          console.warn('Write operation failed: computed value is readonly')
        }
      : NOOP
  } else {
    getter = getterOrOptions.get
    setter = getterOrOptions.set
  }

  const cRef = new ComputedRefImpl(getter, setter, onlyGetter || !setter, isSSR)

  if (__DEV__ && debugOptions && !isSSR) {
    cRef.effect.onTrack = debugOptions.onTrack
    cRef.effect.onTrigger = debugOptions.onTrigger
  }

  return cRef as any
}

class ComputedRefImpl<T> {
  public dep?: Dep = undefined

  private _value!: T
  public readonly effect: ReactiveEffect<T>

  public readonly __v_isRef = true
  public readonly [ReactiveFlags.IS_READONLY]: boolean = false
  // æ ‡è®°æ•°æ®
  public _dirty = true
  public _cacheable: boolean

  constructor(
    getter: ComputedGetter<T>,
    private readonly _setter: ComputedSetter<T>,
    isReadonly: boolean,
    isSSR: boolean
  ) {
    // åˆ›å»ºå‰¯ä½œç”¨å®ä¾‹
    this.effect = new ReactiveEffect(getter, () => {
      if (!this._dirty) {
        this._dirty = true
        triggerRefValue(this)
      }
    })
    this.effect.computed = this
    this.effect.active = this._cacheable = !isSSR
    this[ReactiveFlags.IS_READONLY] = isReadonly
  }

  get value() {
    // å¯¹ value å±æ€§è®¾ç½® getter
    const self = toRaw(this)
    // ä¾èµ–æ”¶é›†
    trackRefValue(self)
    if (self._dirty || !self._cacheable) {
      self._dirty = false
     // æ‰§è¡Œå‰¯ä½œç”¨
      self._value = self.effect.run()
    }
    return self._value
  }

  set value(newValue: T) {
    //  å¯¹ value å±æ€§è®¾ç½® setter
    this._setter(newValue)
  }
}
```

computed å‡½æ•°çš„ getterOrOptions å‚æ•°ï¼Œæ—¢å¯ä»¥æ˜¯ä¸€ä¸ª getter å‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå› æ­¤ computed é¦–å…ˆè¦åšçš„äº‹æƒ…å°±æ˜¯æ ‡å‡†åŒ–å‚æ•°ï¼Œæ‹¿åˆ°è®¡ç®—å±æ€§å¯¹åº”çš„ getter å‡½æ•°å’Œ setter å‡½æ•°ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä¼ é€’çš„å‚æ•°ä»…ä»…æ˜¯ getter å‡½æ•°ï¼Œé‚£ä¹ˆåœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œä¸€äº›ä¿®æ”¹äº†è®¡ç®—å±æ€§çš„å€¼ï¼Œå°±ä¼šæ‰§è¡Œå¯¹åº”çš„ setter å‡½æ•°ï¼Œæé†’ä½ è¯¥è®¡ç®—å±æ€§æ˜¯åªè¯»çš„ã€‚

æ¥ç€ computed å‡½æ•°è¿”å›äº† ComputedRefImpl çš„å®ä¾‹ï¼Œåœ¨å®ƒçš„æ„é€ å™¨å†…éƒ¨ï¼Œé€šè¿‡ new ReactiveEffect çš„æ–¹å¼åˆ›å»ºäº†å‰¯ä½œç”¨å®ä¾‹ effectã€‚

ReactiveEffect æ„é€ å‡½æ•°å¯¹åº”çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª fn å‡½æ•°ï¼Œåœ¨åç»­æ‰§è¡Œ effect.run çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œè¿™ä¸ª fn å‡½æ•°ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª scheduler å‡½æ•°ï¼Œ åœ¨åç»­æ‰§è¡Œæ´¾å‘é€šçŸ¥çš„æ—¶å€™ï¼Œä¼šé€šçŸ¥è¿™ä¸ª effect ä¾èµ–å¯¹è±¡æ‰§è¡Œå¯¹åº”çš„ scheduler å‡½æ•°ã€‚

åœ¨ ComputedRefImpl çš„å†…éƒ¨ï¼Œ è¿˜å¯¹å®ä¾‹ çš„ value å±æ€§åˆ›å»ºäº† getter å’Œ setterï¼Œ å½“ computedå¯¹è±¡çš„ value å±æ€§è¢«è®¿é—®çš„æ—¶å€™ä¼šè§¦å‘ getterï¼Œ å¯¹è®¡ç®—å±æ€§æœ¬èº«è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦ _dirty, å¦‚æœæ˜¯å°±æ‰§è¡Œ effect.run å‡½æ•°ï¼Œå¹¶é‡ç½® _dirty çš„å€¼ï¼›å½“æˆ‘ä»¬ç›´æ¥è®¾ç½® computed å¯¹è±¡çš„value å±æ€§æ—¶ä¼šè§¦å‘ setterï¼Œ å³æ‰§è¡Œ computed å‡½æ•°å†…éƒ¨å®šä¹‰çš„ setter å‡½æ•°ã€‚

### è®¡ç®—å±æ€§çš„è¿è¡Œæœºåˆ¶

é¦–å…ˆçœ‹ä¸ªğŸŒ°

```ts
<template>
    <div>
        {{ plusOne }}
    </div>
    <button @click="plus">plus</button>
</template>
<script>
import { ref, computed } from 'vue'
export default{
    setup(){
        const count = ref(0)
        const plusOne = computed(() => count.value + 1)
        function plus(){
            count.value++;
        }
        return {
            plus,
            plusOne
        }
    }

}

</script>
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨ computed åˆ›å»ºäº†è®¡ç®—å±æ€§å¯¹è±¡ plusOneï¼Œ å®ƒä¼ å…¥çš„æ˜¯ä¸€ä¸ª getterå‡½æ•°ï¼Œ æˆ‘ä»¬ç§°å®ƒä¸º computed getterã€‚å¦å¤–ï¼Œç»„ä»¶æ¨¡ç‰ˆä¸­å¼•ç”¨äº† plusOne å˜é‡å’Œ plus å‡½æ•°ã€‚

> è®¡ç®—å±æ€§æ‹¥æœ‰ __v_isRef å±æ€§ï¼Œæ‰€æœ‰å¯ä»¥ç›´æ¥è®¿é—® plusOne

åœ¨ç»„ä»¶æ¸²æŸ“é˜¶æ®µï¼Œä¼šè®¿é—® plusOne, ä¹Ÿå°±è§¦å‘äº† plusOne å¯¹è±¡çš„ getter å‡½æ•°

```ts
  get value() {
    // å¯¹ value å±æ€§è®¾ç½® getter
    const self = toRaw(this)
    // ä¾èµ–æ”¶é›†
    trackRefValue(self)
    if (self._dirty || !self._cacheable) {

      // åªæœ‰æ•°æ®ä¸º "è„" çš„æ—¶å€™æ‰ä¼šé‡æ–°è®¡ç®—
      self._dirty = false
     // æ‰§è¡Œå‰¯ä½œç”¨
      self._value = self.effect.run()
    }
    return self._value
  }
```

é¦–å…ˆä¼šæ‰§è¡Œ trackRefValue ï¼Œ å¯¹è®¡ç®—å±æ€§æœ¬èº«åšä¾èµ–æ”¶é›†ï¼Œè¿™ä¸ªæ—¶å€™ activeEffect æ˜¯ç»„ä»¶å‰¯ä½œç”¨æ¸²æŸ“å‡½æ•°å¯¹åº”çš„ effect å‡½æ•°ã€‚

ç„¶åå›åˆ¤æ–­ _dirty å±æ€§ï¼Œç”±äº _dirty é»˜è®¤æ˜¯ trueï¼Œ æ‰€ä»¥è¿™ä¸ªæ—¶å€™ä¼šæŠŠ _dirty è®¾ç½®ä¸º falseï¼Œæ¥ç€æ‰§è¡Œè®¡ç®—å±æ€§å†…éƒ¨ effect å¯¹è±¡çš„ run å‡½æ•°ï¼Œå¹¶è¿›ä¸€æ­¥æ‰§è¡Œ computed getterï¼Œä¹Ÿå°±æ˜¯

() => count.value + 1ã€‚å› ä¸ºè®¿é—®äº† count çš„å€¼ï¼Œä¸” count ä¹Ÿæ˜¯ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œæ‰€ä»¥ä¹Ÿä¼šè§¦å‘ count å¯¹è±¡çš„ä¾èµ–æ”¶é›†è¿‡ç¨‹

è¯·æ³¨æ„ï¼Œç”±äºæ˜¯åœ¨ effect.run å‡½æ•°æ‰§è¡Œçš„æ—¶å€™è®¿é—® countï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™çš„ activeEffect æŒ‡å‘è®¡ç®—å±æ€§å†…éƒ¨çš„ effect å¯¹è±¡ã€‚å› æ­¤è¦ç‰¹åˆ«æ³¨æ„ï¼Œè¿™æ˜¯**ä¸¤ä¸ªä¾èµ–æ”¶é›†è¿‡ç¨‹**ï¼šå¯¹äº plusOne æ¥è¯´ï¼Œå®ƒæ”¶é›†çš„ä¾èµ–æ˜¯ç»„ä»¶å‰¯ä½œç”¨æ¸²æŸ“å‡½æ•°å¯¹åº”çš„ effect å¯¹è±¡ï¼›å¯¹äº countï¼Œå®ƒæ”¶é›†çš„ä¾èµ–æ˜¯è®¡ç®—å±æ€§ plusOne å†…éƒ¨çš„ effect å¯¹è±¡ã€‚

å½“æˆ‘ä»¬ç‚¹å‡»æŒ‰é’®çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œ plus å‡½æ•°ã€‚å‡½æ•°å†…éƒ¨é€šè¿‡ count.value++ ä¿®æ”¹ count çš„å€¼ï¼Œå¹¶æ´¾å‘é€šçŸ¥ã€‚ç”±äº count æ”¶é›†çš„ä¾èµ–æ˜¯ plusOne å†…éƒ¨çš„ effect å¯¹è±¡ï¼Œæ‰€ä»¥ä¼šé€šçŸ¥ effect å¯¹è±¡ã€‚ä½†è¯·æ³¨æ„ï¼Œè¿™è¾¹å¹¶ä¸ä¼šç›´æ¥è°ƒç”¨ effect.run å‡½æ•°ï¼Œè€Œæ˜¯ä¼šæ‰§è¡Œeffect.scheduler å‡½æ•°ã€‚

æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ triggerEffects å‡½æ•°çš„å®ç°ï¼š

```ts
function triggerEffects(
  dep: Dep | ReactiveEffect[],
  debuggerEventExtraInfo?: DebuggerEventExtraInfo
) {
  // spread into array for stabilization
  const effects = isArray(dep) ? dep : [...dep]
  for (const effect of effects) {
    if (effect.computed) {
      triggerEffect(effect, debuggerEventExtraInfo)
    }
  }
  for (const effect of effects) {
    if (!effect.computed) {
      triggerEffect(effect, debuggerEventExtraInfo)
    }
  }
}

function triggerEffect(
  effect: ReactiveEffect,
  debuggerEventExtraInfo?: DebuggerEventExtraInfo
) {
  if (effect !== activeEffect || effect.allowRecurse) {
    if (__DEV__ && effect.onTrigger) {
      effect.onTrigger(extend({ effect }, debuggerEventExtraInfo))
    }
    if (effect.scheduler) {
      effect.scheduler()
    } else {
      effect.run()
    }
  }
}
```

ComputedRefImpl å†…éƒ¨åˆ›å»ºå‰¯ä½œç”¨ effect å¯¹è±¡æ—¶ï¼Œå·²ç»é…ç½®äº† scheduler å‡½æ•°ï¼š

```ts
// åˆ›å»ºå‰¯ä½œç”¨å®ä¾‹
    this.effect = new ReactiveEffect(getter, () => {
      if (!this._dirty) {
        this._dirty = true
        triggerRefValue(this)
      }
    })
```

å®ƒå¹¶æ²¡æœ‰å¯¹è®¡ç®—å±æ€§æ±‚æ–°å€¼ï¼Œè€Œä»…ä»…æ˜¯åœ¨ _dirty ä¸º false çš„æ—¶å€™æŠŠ _dirty è®¾ç½®ä¸º trueï¼Œå†æ‰§è¡Œ triggerRefValueï¼Œ å»é€šçŸ¥æ‰§è¡Œ plusOne ä¾èµ–çš„ç»„ä»¶å‰¯ä½œç”¨æ¸²æŸ“å‡½æ•°å¯¹åº”çš„ effect å¯¹è±¡ï¼Œå³è§¦å‘ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ã€‚

åœ¨é‡æ–°æ¸²æŸ“çš„æ—¶å€™ï¼Œä¼šå†æ¬¡è®¿é—® pluseOne, æˆ‘ä»¬å‘ç° _dirty ä¸º trueï¼Œç„¶åä¼šå†æ¬¡ æ‰§è¡Œ computed getterï¼Œ æ­¤æ—¶æ‰ä¼šæ‰§è¡Œ count.value + 1,æ±‚å¾—æ–°å€¼ã€‚è¿™å°±æ˜¯ç»„ä»¶æ²¡æœ‰ç›´æ¥è®¿é—® countï¼Œå´åœ¨æˆ‘ä»¬ä¿®æ”¹ count çš„å€¼æ—¶ï¼Œä»ç„¶é‡æ–°æ¸²æŸ“çš„åŸå› ã€‚

å…·ä½“æŸ¥çœ‹ä¸‹å›¾ï¼š

![](/Users/yxh/Documents/vue/vueæºç é˜…è¯»/img/è®¡ç®—å±æ€§è¿è¡Œæœºåˆ¶.png)

é€šè¿‡ä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºè®¡ç®—å±æ€§æœ‰2ä¸ªç‰¹ç‚¹ï¼š

* å»¶æ—¶è®¡ç®—ã€‚åªæœ‰å½“æˆ‘ä»¬è®¿é—®è®¡ç®—å±æ€§çš„æ—¶å€™ï¼Œå®ƒæ‰ä¼šçœŸæ­£æ‰§è¡Œ counted getter å‡½æ•°è¿›è¡Œè®¡ç®—ã€‚

* ç¼“å­˜ã€‚å®ƒçš„å†…éƒ¨ä¼šç¼“å­˜ä¸Šæ¬¡çš„è®¡ç®—ç»“æœ _value, è€Œä¸”åªæœ‰ _dirty ä¸º true æ—¶æ‰ä¼šé‡æ–°è®¡ç®—ï¼Œå¦‚æœè®¿é—®è®¡ç®—å±æ€§æ—¶ _derty ä¸ºfalseï¼Œé‚£ä¹ˆæ‰§è¡Œè¿”å›è¿™ä¸ª _value.
